# ğŸ”„ Complete Data Flow Diagram

## ğŸ“± Apple Authentication â†’ User Data â†’ Leaderboard Scoring

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER AUTHENTICATION                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                               â”‚
                    â–¼                               â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   APPLE SIGN-IN     â”‚         â”‚    GUEST MODE       â”‚
         â”‚   (Primary Method)  â”‚         â”‚    (Skip Auth)      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                               â”‚
                    â”‚ idToken                       â”‚ No Session
                    â”‚ authorizationCode             â”‚
                    â”‚ email, fullName               â”‚
                    â”‚                               â”‚
                    â–¼                               â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
         â”‚  SUPABASE AUTH      â”‚                   â”‚
         â”‚  â€¢ Validates Apple  â”‚                   â”‚
         â”‚  â€¢ Creates JWT      â”‚                   â”‚
         â”‚  â€¢ Returns User ID  â”‚                   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
                    â”‚                               â”‚
                    â”‚ auth.uid()                    â”‚
                    â”‚                               â”‚
                    â–¼                               â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
         â”‚   USERS TABLE       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚  (Guest: No Entry)
         â”‚  â€¢ id: UUID         â”‚
         â”‚  â€¢ email            â”‚
         â”‚  â€¢ display_name     â”‚
         â”‚  â€¢ avatar_url       â”‚
         â”‚  â€¢ created_at       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ passenger_id (FK)
                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        USER DATA LAYER                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           â”‚           â”‚               â”‚
        â–¼           â–¼           â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ JOURNEYS â”‚ â”‚ FEEDBACK â”‚ â”‚ REVIEWS  â”‚  â”‚   EVENTS    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         JOURNEYS TABLE                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â€¢ id: UUID                                                     â”‚    â”‚
â”‚  â”‚  â€¢ passenger_id: UUID â†’ users.id â—„â”€â”€â”€ USER CONNECTION         â”‚    â”‚
â”‚  â”‚  â€¢ flight_id: UUID â†’ flights.id                                â”‚    â”‚
â”‚  â”‚  â€¢ pnr: TEXT (booking reference)                               â”‚    â”‚
â”‚  â”‚  â€¢ seat_number: TEXT                                           â”‚    â”‚
â”‚  â”‚  â€¢ status: 'scheduled' | 'active' | 'completed'                â”‚    â”‚
â”‚  â”‚  â€¢ current_phase: 'pre_check_in' | 'boarding' | 'in_flight'   â”‚    â”‚
â”‚  â”‚  â€¢ created_at: TIMESTAMPTZ                                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚  RLS POLICY:                                                             â”‚
â”‚    âœ… SELECT: WHERE auth.uid() = passenger_id                           â”‚
â”‚    âœ… INSERT: WITH CHECK auth.uid() = passenger_id                      â”‚
â”‚    âœ… UPDATE: WHERE auth.uid() = passenger_id                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ journey_id (FK)
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           â”‚           â”‚               â”‚
        â–¼           â–¼           â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STAGE        â”‚ â”‚ AIRLINE      â”‚ â”‚ AIRPORT      â”‚ â”‚ JOURNEY      â”‚
â”‚ FEEDBACK     â”‚ â”‚ REVIEWS      â”‚ â”‚ REVIEWS      â”‚ â”‚ EVENTS       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      STAGE_FEEDBACK TABLE                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â€¢ id: UUID                                                     â”‚    â”‚
â”‚  â”‚  â€¢ user_id: UUID â†’ users.id â—„â”€â”€â”€ USER CONNECTION              â”‚    â”‚
â”‚  â”‚  â€¢ journey_id: UUID â†’ journeys.id                              â”‚    â”‚
â”‚  â”‚  â€¢ flight_id: UUID â†’ flights.id                                â”‚    â”‚
â”‚  â”‚  â€¢ stage: 'Pre-Flight' | 'In-Flight' | 'Post-Flight'          â”‚    â”‚
â”‚  â”‚  â€¢ positive_selections: JSONB (likes)                          â”‚    â”‚
â”‚  â”‚  â€¢ negative_selections: JSONB (dislikes)                       â”‚    â”‚
â”‚  â”‚  â€¢ overall_rating: INTEGER (1-5)                               â”‚    â”‚
â”‚  â”‚  â€¢ additional_comments: TEXT                                   â”‚    â”‚
â”‚  â”‚  â€¢ feedback_timestamp: TIMESTAMPTZ                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚  RLS POLICY:                                                             â”‚
â”‚    âœ… SELECT: WHERE auth.uid() = user_id                                â”‚
â”‚    âœ… INSERT: WITH CHECK auth.uid() = user_id                           â”‚
â”‚    âœ… UPDATE: WHERE auth.uid() = user_id                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ TRIGGER: after INSERT or UPDATE
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               SCORING CALCULATION FUNCTION                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  calculate_airline_scores_for_single_airline(airline_id)       â”‚    â”‚
â”‚  â”‚                                                                 â”‚    â”‚
â”‚  â”‚  1. Aggregate all feedback for this airline                    â”‚    â”‚
â”‚  â”‚  2. Calculate raw average score                                â”‚    â”‚
â”‚  â”‚  3. Count total reviews                                        â”‚    â”‚
â”‚  â”‚  4. Apply Bayesian smoothing:                                  â”‚    â”‚
â”‚  â”‚     Formula: (v/(v+m))*S + (m/(v+m))*C                         â”‚    â”‚
â”‚  â”‚     â€¢ v = review count                                         â”‚    â”‚
â”‚  â”‚     â€¢ m = minimum volume (30)                                  â”‚    â”‚
â”‚  â”‚     â€¢ S = raw average                                          â”‚    â”‚
â”‚  â”‚     â€¢ C = global average                                       â”‚    â”‚
â”‚  â”‚  5. Determine confidence level:                                â”‚    â”‚
â”‚  â”‚     â€¢ 0-10 reviews: Low                                        â”‚    â”‚
â”‚  â”‚     â€¢ 11-50 reviews: Medium                                    â”‚    â”‚
â”‚  â”‚     â€¢ 51+ reviews: High                                        â”‚    â”‚
â”‚  â”‚  6. Calculate phase-based weights:                             â”‚    â”‚
â”‚  â”‚     â€¢ Pre-Flight: 20%                                          â”‚    â”‚
â”‚  â”‚     â€¢ In-Flight: 30%                                           â”‚    â”‚
â”‚  â”‚     â€¢ Post-Flight: 50%                                         â”‚    â”‚
â”‚  â”‚  7. Insert/Update leaderboard_scores                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ INSERT/UPDATE
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LEADERBOARD_SCORES TABLE                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â€¢ id: UUID                                                     â”‚    â”‚
â”‚  â”‚  â€¢ airline_id: UUID â†’ airlines.id                              â”‚    â”‚
â”‚  â”‚  â€¢ score_type: 'overall' | 'wifi' | 'seat_comfort' | 'food'   â”‚    â”‚
â”‚  â”‚  â€¢ score_value: DECIMAL (Bayesian adjusted, 0-5.0)            â”‚    â”‚
â”‚  â”‚  â€¢ raw_score: DECIMAL (raw average)                            â”‚    â”‚
â”‚  â”‚  â€¢ review_count: INTEGER                                       â”‚    â”‚
â”‚  â”‚  â€¢ bayesian_score: DECIMAL                                     â”‚    â”‚
â”‚  â”‚  â€¢ confidence_level: 'low' | 'medium' | 'high'                â”‚    â”‚
â”‚  â”‚  â€¢ phases_completed: INTEGER                                   â”‚    â”‚
â”‚  â”‚  â€¢ last_updated: TIMESTAMPTZ                                   â”‚    â”‚
â”‚  â”‚                                                                 â”‚    â”‚
â”‚  â”‚  UNIQUE (airline_id, score_type)                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚  RLS POLICY:                                                             â”‚
â”‚    âœ… SELECT: USING (true)  â—„â”€â”€â”€ PUBLIC READ                           â”‚
â”‚                                                                          â”‚
â”‚  REALTIME:                                                               â”‚
â”‚    âœ… pg_notify('leaderboard_update', NEW.id::text)                     â”‚
â”‚    âœ… Supabase Realtime stream broadcasts changes                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ pg_notify / Realtime Stream
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FLUTTER APP UI LAYER                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  SupabaseLeaderboardService.subscribeToLeaderboardUpdates()   â”‚    â”‚
â”‚  â”‚                                                                 â”‚    â”‚
â”‚  â”‚  â€¢ Listens to leaderboard_scores stream                        â”‚    â”‚
â”‚  â”‚  â€¢ Filters by score_type (overall, wifi, etc.)                 â”‚    â”‚
â”‚  â”‚  â€¢ Orders by score_value DESC                                  â”‚    â”‚
â”‚  â”‚  â€¢ Limits to top 40                                            â”‚    â”‚
â”‚  â”‚  â€¢ Enriches with airline details (name, logo)                  â”‚    â”‚
â”‚  â”‚  â€¢ Returns Stream<List<Map<String, dynamic>>>                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  LeaderboardProvider (Riverpod)                                â”‚    â”‚
â”‚  â”‚                                                                 â”‚    â”‚
â”‚  â”‚  â€¢ Manages leaderboard state                                   â”‚    â”‚
â”‚  â”‚  â€¢ Handles category switching                                  â”‚    â”‚
â”‚  â”‚  â€¢ Formats data for UI                                         â”‚    â”‚
â”‚  â”‚  â€¢ Updates UI automatically on stream changes                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  LeaderboardScreen (UI)                                        â”‚    â”‚
â”‚  â”‚                                                                 â”‚    â”‚
â”‚  â”‚  â€¢ Displays top 40 airlines                                    â”‚    â”‚
â”‚  â”‚  â€¢ Shows airline logos from Supabase                           â”‚    â”‚
â”‚  â”‚  â€¢ Displays scores with 1 decimal (e.g., 4.5)                 â”‚    â”‚
â”‚  â”‚  â€¢ Confidence badges (Low/Medium/High)                         â”‚    â”‚
â”‚  â”‚  â€¢ Real-time updates (no manual refresh)                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EXAMPLE USER JOURNEY                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1ï¸âƒ£  USER SIGNS IN
    â”‚
    â”œâ”€â–º Apple ID: john@example.com
    â”œâ”€â–º Supabase creates: user_id = "abc-123-def-456"
    â””â”€â–º Session stored with JWT token

2ï¸âƒ£  USER ADDS FLIGHT
    â”‚
    â”œâ”€â–º Scans boarding pass: PNR = "XYZ789", Flight = "BA213"
    â”œâ”€â–º Journey created with passenger_id = "abc-123-def-456"
    â””â”€â–º Journey ID = "journey-001"

3ï¸âƒ£  USER SUBMITS PRE-FLIGHT FEEDBACK
    â”‚
    â”œâ”€â–º Likes: "Fast check-in", "Clean lounge"
    â”œâ”€â–º Dislikes: "Long security line"
    â”œâ”€â–º Rating: 4/5
    â”œâ”€â–º Saved to stage_feedback with:
    â”‚   â€¢ user_id = "abc-123-def-456"
    â”‚   â€¢ journey_id = "journey-001"
    â”‚   â€¢ stage = "Pre-Flight"
    â””â”€â–º TRIGGER fires â†’ calculate_airline_scores_for_single_airline(BA)

4ï¸âƒ£  SCORING CALCULATION
    â”‚
    â”œâ”€â–º Aggregate all BA feedback from all users
    â”œâ”€â–º Calculate raw average: 4.2
    â”œâ”€â–º Review count: 25 reviews
    â”œâ”€â–º Apply Bayesian smoothing:
    â”‚   â€¢ v = 25, m = 30, S = 4.2, C = 4.0
    â”‚   â€¢ Score = (25/(25+30))*4.2 + (30/(25+30))*4.0
    â”‚   â€¢ Score = 4.09 (adjusted down due to low review count)
    â”œâ”€â–º Confidence: "Medium" (25 reviews)
    â””â”€â–º Update leaderboard_scores:
        â€¢ airline_id = BA
        â€¢ score_value = 4.09
        â€¢ review_count = 25
        â€¢ confidence_level = "medium"

5ï¸âƒ£  REALTIME UPDATE
    â”‚
    â”œâ”€â–º pg_notify broadcasts: "leaderboard_update"
    â”œâ”€â–º Supabase Realtime stream picks up change
    â””â”€â–º Flutter app receives update via subscribeToLeaderboardUpdates()

6ï¸âƒ£  UI UPDATES
    â”‚
    â”œâ”€â–º LeaderboardProvider updates state
    â”œâ”€â–º LeaderboardScreen re-renders
    â”œâ”€â–º British Airways moves from #5 to #7 (score dropped)
    â””â”€â–º User sees updated rankings (no manual refresh)

7ï¸âƒ£  USER SUBMITS IN-FLIGHT FEEDBACK
    â”‚
    â”œâ”€â–º Likes: "Comfortable seats", "Good entertainment"
    â”œâ”€â–º Dislikes: "Cold meals"
    â”œâ”€â–º Rating: 5/5
    â””â”€â–º Process repeats from step 3

8ï¸âƒ£  FINAL SCORE CALCULATION
    â”‚
    â”œâ”€â–º Pre-Flight: 4/5 (weight: 20% = 0.8)
    â”œâ”€â–º In-Flight: 5/5 (weight: 30% = 1.5)
    â”œâ”€â–º Post-Flight: Not submitted (catch-up: 4.5, weight: 50% = 2.25)
    â”œâ”€â–º Overall = 0.8 + 1.5 + 2.25 = 4.55
    â”œâ”€â–º Apply Bayesian (26 reviews now): 4.14
    â””â”€â–º BA now ranks #6 with score 4.1 â­


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATA SECURITY & ISOLATION                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER A         â”‚         â”‚  USER B         â”‚
â”‚  john@email.com â”‚         â”‚  jane@email.com â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                           â”‚
         â”‚ auth.uid() = "user-A"     â”‚ auth.uid() = "user-B"
         â”‚                           â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ Journey â”‚                 â”‚ Journey â”‚
    â”‚ BA213   â”‚                 â”‚ EK215   â”‚
    â”‚ PNR:ABC â”‚                 â”‚ PNR:XYZ â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚                           â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚Feedback â”‚                 â”‚Feedback â”‚
    â”‚ 4/5 â­  â”‚                 â”‚ 5/5 â­  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    RLS POLICY ENSURES:
    â€¢ User A can ONLY see Journey BA213
    â€¢ User B can ONLY see Journey EK215
    â€¢ User A CANNOT access User B's feedback
    â€¢ User B CANNOT access User A's feedback

    BUT:
    â€¢ Both User A and User B can see the PUBLIC leaderboard
    â€¢ Leaderboard aggregates feedback from ALL users
    â€¢ Individual feedback is anonymous in leaderboard scores


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           SUMMARY                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… USER AUTHENTICATION
   â€¢ Apple Sign-In â†’ Supabase Auth â†’ JWT Token â†’ auth.uid()

âœ… USER DATA LINKING
   â€¢ journeys.passenger_id â†’ users.id
   â€¢ stage_feedback.user_id â†’ users.id
   â€¢ airline_reviews.user_id â†’ users.id

âœ… FEEDBACK â†’ SCORING FLOW
   â€¢ User submits feedback (with user_id)
   â€¢ Trigger calculates airline scores
   â€¢ Bayesian smoothing applied
   â€¢ Leaderboard updated

âœ… REAL-TIME UPDATES
   â€¢ pg_notify broadcasts changes
   â€¢ Supabase Realtime stream
   â€¢ Flutter app subscribes
   â€¢ UI updates automatically

âœ… SECURITY
   â€¢ RLS protects user data
   â€¢ Foreign keys enforce integrity
   â€¢ Public read for leaderboard
   â€¢ Private write for user data

âœ… NO MOCK DATA
   â€¢ All production-ready
   â€¢ Real user authentication
   â€¢ Real feedback aggregation
   â€¢ Real leaderboard scoring
```

